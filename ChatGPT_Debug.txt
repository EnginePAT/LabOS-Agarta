┌──(patrickdodwell㉿kali)-[~/Documents/LabOS-Agarta]
└─$ make      
nasm src/boot.asm -f bin -o build/boot.bin
nasm src/stage2.asm -f bin -o build/stage2.bin
nasm src/kernel/kernel_entry.asm -f elf -o build/kernel_entry.o
i686-elf-gcc -ffreestanding -nostdlib -m32 -g -c src/kernel/kernel.c -o build/kernel.o
i686-elf-ld -Ttext 0x8000 -o build/full_kernel.bin build/kernel_entry.o --oformat binary
i686-elf-ld: build/kernel_entry.o: in function `_start':
src/kernel/kernel_entry.asm:(.text+0x1): undefined reference to `kernel_main'
make: *** [Makefile:34: build/full_kernel.bin] Error 1
                                                                                                                      
┌──(patrickdodwell㉿kali)-[~/Documents/LabOS-Agarta]
└─$ 


kernel.c
void kernel_main();

void kernel_main() {
    *(char*)0xB8000 = 'Q';
    return;
}

kernel_entry.asm
section .text
    global _start
    [bits 32]
_start:
    extern kernel_main
    call kernel_main
    jmp $

Makefile
ASM=nasm
CC=i686-elf-gcc
LD=i686-elf-ld
QEMU=qemu-system-x86_64

CFLAGS=-ffreestanding -nostdlib -m32 -g -c


SRC_DIR=src
BUILD_DIR=build


$(BUILD_DIR)/floppy.img: $(BUILD_DIR)/boot.bin $(BUILD_DIR)/stage2.bin $(BUILD_DIR)/full_kernel.bin
	dd if=/dev/zero of=$@ bs=512 count=2880
	dd if=$(BUILD_DIR)/boot.bin of=$@ conv=notrunc
	dd if=$(BUILD_DIR)/stage2.bin of=$@ bs=512 seek=1 conv=notrunc
	dd if=$(BUILD_DIR)/full_kernel.bin of=$@ bs=512 seek=2 conv=notrunc


#
# Bootloader
#
$(BUILD_DIR)/boot.bin: $(SRC_DIR)/boot.asm
	$(ASM) $< -f bin -o $@

$(BUILD_DIR)/stage2.bin: $(SRC_DIR)/stage2.asm
	$(ASM) $< -f bin -o $@


#
# Kernel
#
$(BUILD_DIR)/full_kernel.bin: $(BUILD_DIR)/kernel_entry.o $(BUILD_DIR)/kernel.o
	$(LD) -Ttext 0x8000 -o $@ $< --oformat binary

$(BUILD_DIR)/kernel_entry.o: $(SRC_DIR)/kernel/kernel_entry.asm
	$(ASM) $< -f elf -o $@

$(BUILD_DIR)/kernel.o: $(SRC_DIR)/kernel/kernel.c
	$(CC) $(CFLAGS) $< -o $@


clean:
	rm -rf $(BUILD_DIR)/*


run: $(BUILD_DIR)/floppy.img
	$(QEMU) -hda $<

